# Cloudflare Workers Configuration
name = "somatic-canticles-api"
main = "api/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# ============================================
# LOCAL DEVELOPMENT (default)
# ============================================
# For local dev, D1 runs locally with wrangler dev
# Database created with: wrangler d1 create somatic-canticles-db-dev

[[d1_databases]]
binding = "DB"
database_name = "somatic-canticles-db-dev"
database_id = "local-dev-db-placeholder"

# R2 Buckets for audio and image storage (dev)
[[r2_buckets]]
binding = "R2_AUDIO"
bucket_name = "canticle-audio-dev"

[[r2_buckets]]
binding = "R2_IMAGES"
bucket_name = "canticle-images-dev"

[vars]
ENVIRONMENT = "development"
JWT_ACCESS_EXPIRY = "900"        # 15 minutes
JWT_REFRESH_EXPIRY = "604800"    # 7 days
RATE_LIMIT_WINDOW = "60"
RATE_LIMIT_MAX = "100"

# KV Namespace for dynamic secrets (optional, enables secret rotation)
# Create with: wrangler kv:namespace create "SECRETS_KV"
# Then add the id below
[[kv_namespaces]]
binding = "SECRETS_KV"
id = "local-dev-kv-placeholder"

# Secrets (set via: wrangler secret put NAME)
# JWT_SECRET - Required for JWT signing
# SENTRY_DSN - Optional for error tracking
# GOOGLE_CLIENT_ID - Google OAuth Client ID
# GOOGLE_CLIENT_SECRET - Google OAuth Client Secret
#
# Use the secrets manager for easier management:
#   bun run secrets:status     # Check which secrets are set
#   bun run secrets:generate   # Generate a new secure secret
#   bun run secrets:put NAME   # Store a secret

# ============================================
# PRODUCTION ENVIRONMENT
# ============================================
# Database created with: wrangler d1 create somatic-canticles-db
# Then update database_id below

[env.production]
name = "somatic-canticles-api-prod"

[[env.production.d1_databases]]
binding = "DB"
database_name = "somatic-canticles-db"
database_id = "df9d20f7-9ad3-45a9-b08d-e41b849f0ee6"

# Production R2 buckets
[[env.production.r2_buckets]]
binding = "R2_AUDIO"
bucket_name = "canticle-audio"

[[env.production.r2_buckets]]
binding = "R2_IMAGES"
bucket_name = "canticle-images"

# Production KV namespace
# Created: 2026-02-09
[[env.production.kv_namespaces]]
binding = "SECRETS_KV"
id = "fdd6d9d72d584d7ebb2e768d6f1aea35"

[env.production.vars]
ENVIRONMENT = "production"
JWT_ACCESS_EXPIRY = "900"
JWT_REFRESH_EXPIRY = "604800"
RATE_LIMIT_WINDOW = "60"
RATE_LIMIT_MAX = "100"
